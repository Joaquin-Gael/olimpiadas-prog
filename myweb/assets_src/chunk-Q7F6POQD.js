import{a as T}from"./chunk-RO3E3J3P.js";import{b as R}from"./chunk-VLZLEZCB.js";import{b as f,m}from"./chunk-CK4HYLRU.js";import{$ as l,E as i,Q as a,Y as n,da as c,o as d,p as h,s as t}from"./chunk-HNZQVEQV.js";var g={REGISTER:"/users/register",LOGIN:"/users/login",REFRESH:"/users/refresh"};var u=class p{constructor(o,e,r){this.apiService=o;this.logger=e;this.storage=r}TIMEOUT_MS=1e4;RETRY_COUNT=2;isLoggedIn(){return!!this.storage.getToken()}register(o){return this.apiService.post(g.REGISTER,o).pipe(t(this.TIMEOUT_MS),a(this.RETRY_COUNT),n(()=>this.logger.debug("Usuario registrado exitosamente")),i(e=>this.handleError("Registro de usuario",e)))}login(o){return this.apiService.post(g.LOGIN,o).pipe(t(this.TIMEOUT_MS),a(this.RETRY_COUNT),n(e=>{e.data?.access_token&&(this.storage.setToken(e.data.access_token),e.data.refresh_token&&this.storage.setRefreshToken(e.data.refresh_token),this.logger.debug("Inicio de sesi\xF3n exitoso"))}),i(e=>this.handleError("Inicio de sesi\xF3n",e)))}refreshToken(){let o=this.storage.getRefreshToken();if(!o)return this.storage.clearStorage(),this.logger.error("No hay refresh token disponible"),h(()=>new Error("No hay refresh token disponible"));let e=new f({"Content-Type":"application/json",Authorization:"Bearer "+o});return this.apiService.get(g.REFRESH,{headers:e}).pipe(t(this.TIMEOUT_MS),a(this.RETRY_COUNT),n(r=>{r.data?.access_token&&(this.storage.setToken(r.data?.access_token),this.logger.debug("Token refrescado exitosamente"))}),i(r=>this.handleError("Refrescar token",r)))}logout(){return this.storage.clearStorage(),this.logger.debug("Sesi\xF3n cerrada exitosamente"),d(void 0)}handleError(o,e){this.logger.error(`${o} fall\xF3`,e);let r="Ocurri\xF3 un error inesperado";if(e instanceof Error)r=e.message;else if(typeof e=="object"&&e!==null&&"status"in e){let s=e;switch(s.status){case 400:r=s.error?.message||s.error?.detail||"Datos de solicitud inv\xE1lidos";break;case 401:r=s.error?.message||"Credenciales inv\xE1lidas o token expirado",this.storage.clearStorage();break;case 403:r=s.error?.message||"Acci\xF3n no permitida";break;case 404:r=s.error?.message||"Recurso no encontrado";break;default:r=s.error?.message||"Error del servidor"}}return h(()=>new Error(r))}static \u0275fac=function(e){return new(e||p)(c(R),c(m),c(T))};static \u0275prov=l({token:p,factory:p.\u0275fac,providedIn:"root"})};export{g as a,u as b};
