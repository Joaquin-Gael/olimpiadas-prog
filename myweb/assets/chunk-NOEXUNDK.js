import{a as m}from"./chunk-E2GOPQML.js";import{b as S}from"./chunk-AT2QGDAO.js";import{b as T,m as p}from"./chunk-RGOLDJ7I.js";import{$ as d,E as a,Q as g,W as E,Y as n,da as l,k as v,o,p as h,s as u}from"./chunk-JIXPPSV7.js";var c={LIST_USERS:"/users/",GET_USER:i=>`/users/${i}`,UPDATE_USER:i=>`/users/${i}`,DELETE_USER:i=>`/users/${i}`,GET_ME:"/users/me"};var f=class i{constructor(r,e,t){this.apiService=r;this.logger=e;this.storage=t}TIMEOUT_MS=1e4;RETRY_COUNT=2;isLoggedIn(){return!!this.storage.getToken()}getAll(){return this.isLoggedIn()?this.apiService.get(c.LIST_USERS).pipe(u(this.TIMEOUT_MS),g(this.RETRY_COUNT),n(()=>this.logger.debug("Usuarios obtenidos exitosamente")),a(r=>(this.logger.error("Obtener todos los usuarios fall\xF3",r),o([])))):(this.logger.debug("Usuario no autenticado, retornando array vac\xEDo"),o([]))}getById(r){return this.isLoggedIn()?this.apiService.get(c.GET_USER(Number(r))).pipe(u(this.TIMEOUT_MS),g(this.RETRY_COUNT),n(()=>this.logger.debug(`Usuario ${r} obtenido exitosamente`)),a(e=>(this.logger.error(`Obtener usuario ${r} fall\xF3`,e),o(null)))):(this.logger.debug("Usuario no autenticado, retornando null"),o(null))}getMe(){return this.isLoggedIn()?this.apiService.get(c.GET_ME).pipe(u(this.TIMEOUT_MS),g(this.RETRY_COUNT),n(()=>this.logger.debug("Datos del usuario autenticado obtenidos exitosamente")),a(r=>(this.logger.error("Obtener datos del usuario autenticado fall\xF3",r),o(null)))):(this.logger.debug("Usuario no autenticado, retornando null"),o(null))}update(r,e){return this.apiService.put(c.UPDATE_USER(Number(r)),e).pipe(u(this.TIMEOUT_MS),g(this.RETRY_COUNT),n(()=>this.logger.debug(`Usuario ${r} actualizado exitosamente`)),a(t=>this.handleError(`Actualizar usuario ${r}`,t)))}delete(r){return this.apiService.delete(c.DELETE_USER(Number(r))).pipe(u(this.TIMEOUT_MS),g(this.RETRY_COUNT),n(()=>this.logger.debug(`Usuario ${r} eliminado exitosamente`)),a(e=>this.handleError(`Eliminar usuario ${r}`,e)))}handleError(r,e){this.logger.error(`${r} fall\xF3`,e);let t="Ocurri\xF3 un error inesperado";if(e instanceof Error)t=e.message;else if(typeof e=="object"&&e!==null&&"status"in e){let s=e;switch(s.status){case 400:t=s.error?.message||s.error?.detail||"Datos de solicitud inv\xE1lidos";break;case 401:t=s.error?.message||"Credenciales inv\xE1lidas o token expirado",this.storage.clearStorage();break;case 403:t=s.error?.message||"Acci\xF3n no permitida";break;case 404:t=s.error?.message||"Recurso no encontrado";break;default:t=s.error?.message||"Error del servidor"}}return h(()=>new Error(t))}static \u0275fac=function(e){return new(e||i)(l(S),l(p),l(m))};static \u0275prov=d({token:i,factory:i.\u0275fac,providedIn:"root"})};var b={REGISTER:"/users/register",LOGIN:"/users/login",REFRESH:"/users/refresh"};var R=class i{constructor(r,e,t,s){this.apiService=r;this.logger=e;this.storage=t;this.userService=s;this.checkInitialAuthState()}TIMEOUT_MS=1e4;RETRY_COUNT=2;authState$=new v({isLoggedIn:!1,user:null});checkInitialAuthState(){this.isLoggedIn()?this.userService.getMe().pipe(n(r=>{this.authState$.next({isLoggedIn:!0,user:r}),this.logger.debug("Estado inicial: usuario autenticado",r)}),a(r=>(this.logger.error("Error al verificar estado inicial",r),this.storage.clearStorage(),this.authState$.next({isLoggedIn:!1,user:null}),o(null)))).subscribe():(this.authState$.next({isLoggedIn:!1,user:null}),this.logger.debug("Estado inicial: usuario no autenticado"))}getAuthState(){return this.authState$.asObservable()}updateAuthState(r){this.authState$.next(r),this.logger.debug("Estado de autenticaci\xF3n actualizado:",r)}isLoggedIn(){return!!this.storage.getToken()}register(r){return this.apiService.post(b.REGISTER,r).pipe(u(this.TIMEOUT_MS),g(this.RETRY_COUNT),n(()=>this.logger.debug("Usuario registrado exitosamente")),a(e=>this.handleError("Registro de usuario",e)))}login(r){return this.apiService.post(b.LOGIN,r).pipe(u(this.TIMEOUT_MS),g(this.RETRY_COUNT),E(e=>e.data?.access_token?(this.storage.setToken(e.data.access_token),e.data.refresh_token&&this.storage.setRefreshToken(e.data.refresh_token),this.logger.debug("Inicio de sesi\xF3n exitoso"),this.userService.getMe().pipe(n(t=>{this.authState$.next({isLoggedIn:!0,user:t}),this.logger.debug("Datos del usuario cargados tras login:",t)}),E(()=>o(e)))):o(e)),a(e=>(this.authState$.next({isLoggedIn:!1,user:null}),this.handleError("Inicio de sesi\xF3n",e))))}refreshToken(){let r=this.storage.getRefreshToken();if(!r)return this.storage.clearStorage(),this.authState$.next({isLoggedIn:!1,user:null}),this.logger.error("No hay refresh token disponible"),h(()=>new Error("No hay refresh token disponible"));let e=new T({"Content-Type":"application/json",Authorization:"Bearer "+r});return this.apiService.get(b.REFRESH,{headers:e}).pipe(u(this.TIMEOUT_MS),g(this.RETRY_COUNT),n(t=>{t.data?.access_token&&(this.storage.setToken(t.data.access_token),this.logger.debug("Token refrescado exitosamente"),this.userService.getMe().pipe(n(s=>{this.authState$.next({isLoggedIn:!0,user:s}),this.logger.debug("Datos del usuario actualizados tras refresh:",s)}),a(s=>(this.logger.error("Error al actualizar datos del usuario tras refresh",s),this.storage.clearStorage(),this.authState$.next({isLoggedIn:!1,user:null}),o(null)))).subscribe())}),a(t=>(this.storage.clearStorage(),this.authState$.next({isLoggedIn:!1,user:null}),this.handleError("Refrescar token",t))))}logout(){return this.storage.clearStorage(),this.authState$.next({isLoggedIn:!1,user:null}),this.logger.debug("Sesi\xF3n cerrada exitosamente"),o(void 0)}handleError(r,e){this.logger.error(`${r} fall\xF3`,e);let t="Ocurri\xF3 un error inesperado";if(e instanceof Error)t=e.message;else if(typeof e=="object"&&e!==null&&"status"in e){let s=e;switch(s.status){case 400:t=s.error?.message||s.error?.detail||"Datos de solicitud inv\xE1lidos";break;case 401:t=s.error?.message||"Credenciales inv\xE1lidas o token expirado",this.storage.clearStorage(),this.authState$.next({isLoggedIn:!1,user:null});break;case 403:t=s.error?.message||"Acci\xF3n no permitida";break;case 404:t=s.error?.message||"Recurso no encontrado";break;default:t=s.error?.message||"Error del servidor"}}return h(()=>new Error(t))}static \u0275fac=function(e){return new(e||i)(l(S),l(p),l(m),l(f))};static \u0275prov=d({token:i,factory:i.\u0275fac,providedIn:"root"})};export{b as a,f as b,R as c};
